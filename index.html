<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>摔倒监测上传</title>
</head>
<body>
  <h2>摔倒监测系统</h2>
  <button onclick="connectBluetooth()">连接蓝牙设备</button>
  <p id="status">设备未连接</p>
  <p id="location">定位中...</p>

  <script src="https://unpkg.com/paho-mqtt/mqttws31.min.js"></script>
  <script>
    const serviceUUID = "abcd1234-1234-1234-1234-abcdefabcdef"; // 替换为你的 BLE 服务 UUID
    const characteristicUUID = "abcd1234-1234-1234-1234-abcdefabcdef"; // 替换为你的特征 UUID

    let lat = null, lng = null;

    // 获取 GPS 位置
    navigator.geolocation.getCurrentPosition((position) => {
      lat = position.coords.latitude;
      lng = position.coords.longitude;
      document.getElementById("location").innerText = `位置：${lat}, ${lng}`;
    }, (err) => {
      document.getElementById("location").innerText = "无法获取位置（需要 HTTPS）";
    });

    async function connectBluetooth() {
      try {
        const device = await navigator.bluetooth.requestDevice({
          filters: [{ services: [serviceUUID] }]
        });
        const server = await device.gatt.connect();
        const service = await server.getPrimaryService(serviceUUID);
        const characteristic = await service.getCharacteristic(characteristicUUID);

        document.getElementById("status").innerText = "蓝牙已连接，监听中...";

        await characteristic.startNotifications();
        characteristic.addEventListener('characteristicvaluechanged', (event) => {
          const value = event.target.value.getUint8(0);
          if (value === 1) {
            document.getElementById("status").innerText = "检测到摔倒，上传中...";
            sendToMQTT();
          }
        });
      } catch (err) {
        alert("连接失败：" + err);
      }
    }

    function sendToMQTT() {
      const client = new Paho.MQTT.Client("your-endpoint", 443, "clientid" + Math.random());
      client.connect({
        userName: "your-username",
        password: "your-password",
        useSSL: true,
        onSuccess: () => {
          const payload = JSON.stringify({ status: "fall", lat: lat, lng: lng });
          const message = new Paho.MQTT.Message(payload);
          message.destinationName = "your-topic";
          client.send(message);
          document.getElementById("status").innerText = "已上传到 MQTT";
        },
        onFailure: (err) => {
          alert("MQTT连接失败：" + JSON.stringify(err));
        }
      });
    }
  </script>
</body>
</html>
