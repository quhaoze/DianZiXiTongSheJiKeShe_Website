<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>摔倒监测系统</title>
</head>
<body>
  <h2>摔倒监测系统</h2>
  <button onclick="connectBluetooth()">连接蓝牙设备</button>
  <p id="status">设备未连接</p>
  <p id="location">定位中...</p>

  <script src="https://unpkg.com/paho-mqtt/mqttws31.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.min.js"></script>
  <script>
    const serviceUUID = "12345678-1234-1234-1234-1234567890ab";  // 替换为蓝牙服务 UUID
    const characteristicUUID = "abcd1234-1234-1234-1234-abcdefabcdef"; // 替换为特征 UUID

    const deviceId = "detector";
    const deviceSecret = "Detector123456";
    const mqttHost = "iot-mqtts.cn-north-4.myhuaweicloud.com"; // 华为云 IoT MQTT 地址
    const mqttPort = 443;

    let lat = null, lng = null;

    // 获取当前定位
    navigator.geolocation.getCurrentPosition(
      position => {
        lat = position.coords.latitude;
        lng = position.coords.longitude;
        document.getElementById("location").innerText = `位置：${lat}, ${lng}`;
      },
      err => {
        document.getElementById("location").innerText = "无法获取位置（需要 HTTPS）";
      }
    );

    async function connectBluetooth() {
      try {
        const device = await navigator.bluetooth.requestDevice({
          filters: [{ services: [serviceUUID] }]
        });
        const server = await device.gatt.connect();
        const service = await server.getPrimaryService(serviceUUID);
        const characteristic = await service.getCharacteristic(characteristicUUID);

        document.getElementById("status").innerText = "蓝牙已连接，监听中...";

        await characteristic.startNotifications();
        characteristic.addEventListener('characteristicvaluechanged', event => {
          const value = event.target.value;
          const fallStatus = value.getUint8(0);           // 0 = 正常，1 = 摔倒
          const directionCode = value.getUint8(1);        // 0 = 前，1 = 后，2 = 左，3 = 右
          const directionMap = ["前", "后", "左", "右"];
          const direction = directionMap[directionCode] || "未知";

          if (fallStatus === 1) {
            document.getElementById("status").innerText = `检测到摔倒（方向：${direction}），上传中...`;
            sendToMQTT(direction);
          }
        });
      } catch (err) {
        alert("蓝牙连接失败：" + err);
      }
    }

    function sendToMQTT(direction) {
      const timestamp = Date.now();
      const clientId = `${deviceId}|securemode=3,signmethod=hmacsha256,timestamp=${timestamp}|`;
      const signContent = `clientId${deviceId}deviceName${deviceId}timestamp${timestamp}`;
      const signature = CryptoJS.HmacSHA256(signContent, deviceSecret).toString();
      const username = `${deviceId};${timestamp}`;
      const password = signature;

      const client = new Paho.MQTT.Client(mqttHost, mqttPort, clientId);

      client.connect({
        userName: username,
        password: password,
        useSSL: true,
        onSuccess: () => {
          const topic = `$oc/devices/${deviceId}/sys/properties/report`;
          const payload = JSON.stringify({
            services: [{
              service_id: "FallDevice",
              properties: {
                fall: 1,
                direction: direction,
                latitude: lat,
                longitude: lng
              },
              event_time: new Date().toISOString()
            }]
          });
          const message = new Paho.MQTT.Message(payload);
          message.destinationName = topic;
          client.send(message);
          document.getElementById("status").innerText = `已上传至华为云平台：${direction}摔倒`;
        },
        onFailure: err => {
          console.error("MQTT连接失败", err);
          alert("MQTT连接失败：" + JSON.stringify(err));
        }
      });
    }
  </script>
</body>
</html>
