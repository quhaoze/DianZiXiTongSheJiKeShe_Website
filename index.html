<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>摔倒监测上传</title>
</head>
<body>
  <h2>摔倒监测系统</h2>
  <button onclick="connectBluetooth()">连接蓝牙设备</button>
  <p id="status">设备未连接</p>
  <p id="location">定位中...</p>

  <script src="https://unpkg.com/paho-mqtt/mqttws31.min.js"></script>
  <script>
    const serviceUUID = "12345678-1234-1234-1234-1234567890ab";
    const characteristicUUID = "abcd1234-1234-1234-1234-abcdefabcdef";

    let lat = null, lng = null;

    // 获取当前定位信息
    navigator.geolocation.getCurrentPosition(
      (position) => {
        lat = position.coords.latitude;
        lng = position.coords.longitude;
        document.getElementById("location").innerText = `位置：${lat.toFixed(6)}, ${lng.toFixed(6)}`;
      },
      (err) => {
        document.getElementById("location").innerText = "无法获取位置（需要 HTTPS）";
      }
    );

    async function connectBluetooth() {
      try {
        const device = await navigator.bluetooth.requestDevice({
          filters: [{ namePrefix: "ESP32-Fall" }],
          optionalServices: [serviceUUID]
        });

        const server = await device.gatt.connect();
        const service = await server.getPrimaryService(serviceUUID);
        const characteristic = await service.getCharacteristic(characteristicUUID);

        document.getElementById("status").innerText = "蓝牙已连接，监听中...";

        await characteristic.startNotifications();
        characteristic.addEventListener('characteristicvaluechanged', (event) => {
          const decoder = new TextDecoder("utf-8");
          const jsonStr = decoder.decode(event.target.value);
          console.log("接收到BLE数据:", jsonStr);

          try {
            const data = JSON.parse(jsonStr);

            if (data.fall === 1) {
              document.getElementById("status").innerText = `检测到摔倒，方向：${data.dir}，上传中...`;
              sendToMQTT(data.dir);
            } else {
              document.getElementById("status").innerText = `状态正常，方向：${data.dir}`;
            }

          } catch (e) {
            console.error("JSON 解析失败:", e);
            document.getElementById("status").innerText = "收到无效数据";
          }
        });

      } catch (err) {
        alert("蓝牙连接失败：" + err);
      }
    }

    function sendToMQTT(direction) {
      const client = new Paho.MQTT.Client("your-endpoint", 443, "clientid" + Math.random());

      client.connect({
        userName: "your-username",
        password: "your-password",
        useSSL: true,
        onSuccess: () => {
          const payload = JSON.stringify({
            status: "fall",
            direction: direction,
            lat: lat,
            lng: lng,
            time: new Date().toISOString()
          });

          const message = new Paho.MQTT.Message(payload);
          message.destinationName = "your-topic"; // 替换为你实际的 topic
          client.send(message);

          document.getElementById("status").innerText = `摔倒信息已上传：方向 ${direction}`;
        },
        onFailure: (err) => {
          alert("MQTT连接失败：" + JSON.stringify(err));
        }
      });
    }
  </script>
</body>
</html>
